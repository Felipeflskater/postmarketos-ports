# Maintainer: Felipe Prestes Aranalde <felipe.aranalde@gmail.com>
pkgname=linux-samsung-matisse3g
pkgver=4.4.302
pkgrel=0
pkgdesc="Linux kernel for Samsung Galaxy Tab 4 10.1 (SM-T531) - LineageOS 18.1"
arch="armv7"
url="https://github.com/felipeflskater/android_kernel_samsung_msm8226"
license="GPL-2.0-only"
options="!strip !check !tracedeps"
makedepends="
	bc
	bison
	flex
	perl
	python3
	gmp-dev
	mpfr-dev
	mpc1-dev
	gettext-dev
	bash
	findutils
	xz
"
subpackages=""
source="
	https://github.com/felipeflskater/android_kernel_samsung_msm8226/archive/refs/heads/pmos-matisse3g-fixes.tar.gz
	config-samsung-matisse3g.armv7
"
builddir="$srcdir/android_kernel_samsung_msm8226-pmos-matisse3g-fixes"

prepare() {
	default_prepare
	cd "$builddir"
	echo "[*] Preparando kernel LineageOS 18.1 para matisse3g"

	# Define ambiente
	export ARCH=arm
	export CROSS_COMPILE=armv7-alpine-linux-musleabihf-

	# Fix DIRETO para compatibilidade com C23 - remove definições conflitantes
	echo "[*] Aplicando fix direto para compatibilidade C23..."

	# Remove enum false/true de stddef.h
	sed -i '/^enum {$/,/^};$/d' include/linux/stddef.h

	# Remove typedef bool de types.h
	sed -i '/^typedef _Bool.*bool;$/d' include/linux/types.h

	# Força C11 no Makefile principal
	sed -i '/^HOSTCFLAGS.*:=/d' Makefile
	sed -i '/^HOSTCXXFLAGS.*:=/d' Makefile
	sed -i '/^KBUILD_HOSTCFLAGS.*:=/d' Makefile
	sed -i '/^KBUILD_HOSTCXXFLAGS.*:=/d' Makefile

	# Adiciona definições C11 no início do Makefile
	sed -i '1i# Force C11 for compatibility with modern GCC' Makefile
	sed -i '2i HOSTCFLAGS := -Wall -Wmissing-prototypes -Wstrict-prototypes -O2 -fomit-frame-pointer -std=gnu11' Makefile
	sed -i '3i HOSTCXXFLAGS := -O2 -std=gnu++11' Makefile
	sed -i '4i KBUILD_HOSTCFLAGS := $(HOSTCFLAGS)' Makefile
	sed -i '5i KBUILD_HOSTCXXFLAGS := $(HOSTCXXFLAGS)' Makefile
	sed -i '6i ' Makefile

	# Fix para scripts/mod/Makefile
	if [ -f scripts/mod/Makefile ]; then
		sed -i '1i HOSTCFLAGS += -std=gnu11' scripts/mod/Makefile
	fi

	# Fix para missing msm_rtb.h header
	echo "[*] Aplicando fix para headers MSM faltantes..."
	if [ ! -f arch/arm/include/asm/mach/msm_rtb.h ]; then
		mkdir -p arch/arm/include/asm/mach
		cat > arch/arm/include/asm/mach/msm_rtb.h << 'EOF'
#ifndef __ASM_ARCH_MSM_RTB_H
#define __ASM_ARCH_MSM_RTB_H

/* Stub header for missing MSM RTB functionality */
static inline void uncached_logk_pc(enum logk_event_type log_type, void *caller,
				void *data) { }
static inline void uncached_logk(enum logk_event_type log_type, void *data) { }

#endif /* __ASM_ARCH_MSM_RTB_H */
EOF
	fi

	# Fix alternativo - comentar a inclusão se o header não existe
	if [ -f arch/arm/include/asm/io.h ]; then
		sed -i 's/#include <mach\/msm_rtb.h>/\/\* #include <mach\/msm_rtb.h> \*\//' arch/arm/include/asm/io.h
	fi

	# Aplica configuração
	cp "$srcdir"/config-samsung-matisse3g.armv7 .config

	# Gera configuração final (kernel 4.4 usa oldnoconfig)
	echo "[*] Aplicando configuração do kernel..."
	if make help 2>/dev/null | grep -q olddefconfig; then
		make olddefconfig
	elif make help 2>/dev/null | grep -q oldnoconfig; then
		yes "" | make oldnoconfig
	else
		yes "" | make oldconfig
	fi
}

build() {
	cd "$builddir"
	export ARCH=arm
	export CROSS_COMPILE=armv7-alpine-linux-musleabihf-

	echo "[*] Compilando kernel..."
	make -j$(nproc) zImage dtbs modules
}

package() {
	cd "$builddir"
	# Instala kernel
	install -Dm644 arch/arm/boot/zImage "$pkgdir/boot/vmlinuz"

	# Instala DTBs se existirem
	if [ -d arch/arm/boot/dts/ ]; then
		for dtb in arch/arm/boot/dts/*.dtb; do
			[ -f "$dtb" ] && install -Dm644 "$dtb" "$pkgdir/boot/$(basename $dtb)"
		done
	fi

	# Instala módulos
	make ARCH=arm CROSS_COMPILE=armv7-alpine-linux-musleabihf- \
		INSTALL_MOD_PATH="$pkgdir" modules_install
}

sha512sums="
963d7aece14005735b0fe699ad50b903808019413ccf104772243e64f1d1ab8e571ae9bd32b7aedf86c8888fb3e09ede00a047277c01bfa104b4e6ea6848b0e5  pmos-matisse3g-fixes.tar.gz
368d9943e57a810302391903b3c7531d23c4fddd3f48733c168c2e4d2a691275d5ca89377e9178e982e014d797ac7a923dde07ecf92e7e10bfe7653e823e8174  config-samsung-matisse3g.armv7
"
