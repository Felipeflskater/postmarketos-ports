# Maintainer: Felipe Prestes Aranalde <felipe.aranalde@gmail.com>
pkgname=linux-samsung-matisse3g
pkgver=3.4.113
pkgrel=4
pkgdesc="Linux kernel for Samsung Galaxy Tab 4 10.1 (SM-T531) - LineageOS"
arch="armv7"
_flavor="samsung-matisse3g"
url="https://github.com/felipeflskater/android_kernel_samsung_msm8226"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="
	bash bc bison devicepkg-dev dtbtool elfutils-dev findutils flex
	gettext-dev gmp-dev installkernel linux-headers mpc1-dev mpfr-dev
	perl python3 sed xz
"

_commit="pmos-matisse3g-fixes"
_cross_prefix="armv7-alpine-linux-musleabihf-"

source="
	$pkgname-$_commit.tar.gz::https://github.com/felipeflskater/android_kernel_samsung_msm8226/archive/refs/heads/pmos-matisse3g-fixes.tar.gz
	config-samsung-matisse3g.armv7
"
builddir="$srcdir/android_kernel_samsung_msm8226-pmos-matisse3g-fixes"

_log() {
    printf "\n[*] %s\n" "$1"
}

_die() {
    _log "ERRO: $1"
    exit 1
}

prepare() {
    cd "$builddir"
    _log "Preparando kernel com correções específicas para Matisse3G - VERSÃO OTIMIZADA"

    # ============ LIMPEZA COMPLETA ============
    unset LDFLAGS CPPFLAGS CFLAGS CXXFLAGS
    export LDFLAGS=""
    export CPPFLAGS=""
    export CFLAGS=""
    export CXXFLAGS=""

    # ============ AMBIENTE BÁSICO ============
    export ARCH=arm
    export SUBARCH=arm
    export CROSS_COMPILE="${_cross_prefix}"

    # ============ FLAGS OTIMIZADAS ============
    local gcc_flags="-std=gnu89 -fno-stack-protector -fno-strict-aliasing -fno-common -Wno-error -fno-PIE -no-pie"
    local host_flags="-fno-PIE -no-pie -fno-stack-protector -Wno-error"

    export HOSTCFLAGS="$host_flags"
    export HOSTLDFLAGS="-no-pie"
    export KBUILD_HOSTCFLAGS="$host_flags"
    export KBUILD_HOSTLDFLAGS="-no-pie"
    export KBUILD_CFLAGS_KERNEL="$gcc_flags"
    export KBUILD_LDFLAGS=""

    # ============ CORREÇÃO 1: STDDEF.H ============
    _log "CORREÇÃO 1: stddef.h com enum simples"

    rm -f include/linux/postmarketos-compat.h 2>/dev/null || true
    mkdir -p include/uapi/linux include/uapi/asm

    # uapi/linux/stddef.h
    cat > include/uapi/linux/stddef.h << 'EOF'
#ifndef _UAPI_LINUX_STDDEF_H
#define _UAPI_LINUX_STDDEF_H

#ifndef __ASSEMBLY__
#ifndef NULL
#ifdef __cplusplus
#define NULL 0
#else
#define NULL ((void *)0)
#endif
#endif
#endif /* __ASSEMBLY__ */

#endif /* _UAPI_LINUX_STDDEF_H */
EOF

    # stddef.h com enum (sem typedef _Bool)
    cat > include/linux/stddef.h << 'EOF'
#ifndef _LINUX_STDDEF_H
#define _LINUX_STDDEF_H

#include <uapi/linux/stddef.h>

#ifndef __ASSEMBLY__

/* Enum simples para evitar problemas de typedef */
#undef false
#undef true
enum {
	false	= 0,
	true	= 1
};

#undef offsetof
#ifdef __compiler_offsetof
#define offsetof(TYPE, MEMBER)	__compiler_offsetof(TYPE, MEMBER)
#else
#define offsetof(TYPE, MEMBER)	((size_t) &((TYPE *)0)->MEMBER)
#endif

#endif /* __ASSEMBLY__ */
#endif /* _LINUX_STDDEF_H */
EOF

    # ============ CORREÇÃO 2: __USER ============
    _log "CORREÇÃO 2: Resolvendo problema __user"

    # Garantir definições no compiler.h
    if [ -f include/linux/compiler.h ]; then
        cp include/linux/compiler.h include/linux/compiler.h.backup

        cat > include/linux/compiler.h.new << 'EOF'
/* Definições Sparse essenciais - DEVEM vir antes de tudo */
#ifndef __CHECKER__
# define __user
# define __kernel
# define __iomem
# define __safe
# define __force
# define __nocast
# define __acquires(x)
# define __releases(x)
# define __acquire(x)	(void)0
# define __release(x)	(void)0
# define __cond_lock(x,c) (c)
#else
# define __user         __attribute__((noderef, address_space(1)))
# define __kernel       __attribute__((address_space(0)))
# define __iomem        __attribute__((noderef, address_space(2)))
# define __safe         __attribute__((safe))
# define __force        __attribute__((force))
# define __nocast       __attribute__((nocast))
# define __acquires(x)  __attribute__((context(x,0,1)))
# define __releases(x)  __attribute__((context(x,1,0)))
# define __acquire(x)   __context__(x,1)
# define __release(x)   __context__(x,-1)
# define __cond_lock(x,c) ((c) ? ({ __acquire(x); 1; }) : 0)
#endif

EOF
        cat include/linux/compiler.h >> include/linux/compiler.h.new
        mv include/linux/compiler.h.new include/linux/compiler.h
    fi

    # Aplicar correção específica para arch/arm/kernel/smp_tlb.c
    if [ -f arch/arm/kernel/smp_tlb.c ]; then
        cp arch/arm/kernel/smp_tlb.c arch/arm/kernel/smp_tlb.c.backup

        cat > arch/arm/kernel/smp_tlb.c << 'EOF'
/*
 *  linux/arch/arm/kernel/smp_tlb.c
 *
 *  Copyright (C) 2002 ARM Limited, All Rights Reserved.
 */

#include <linux/compiler.h>
#include <linux/preempt.h>
#include <linux/smp.h>

#include <asm/smp_plat.h>
#include <asm/tlbflush.h>
#include <asm/mmu_context.h>

struct tlb_args {
	struct vm_area_struct *ta_vma;
	unsigned long ta_start;
	unsigned long ta_end;
};

static inline void ipi_flush_tlb_all(void *ignored)
{
	local_flush_tlb_all();
}

static inline void ipi_flush_tlb_mm(void *arg)
{
	struct mm_struct *mm = (struct mm_struct *)arg;
	local_flush_tlb_mm(mm);
}

static inline void ipi_flush_tlb_page(void *arg)
{
	struct tlb_args *ta = (struct tlb_args *)arg;
	local_flush_tlb_page(ta->ta_vma, ta->ta_start);
}

static inline void ipi_flush_tlb_kernel_page(void *arg)
{
	struct tlb_args *ta = (struct tlb_args *)arg;
	local_flush_tlb_kernel_page(ta->ta_start);
}

static inline void ipi_flush_tlb_range(void *arg)
{
	struct tlb_args *ta = (struct tlb_args *)arg;
	local_flush_tlb_range(ta->ta_vma, ta->ta_start, ta->ta_end);
}

static inline void ipi_flush_tlb_kernel_range(void *arg)
{
	struct tlb_args *ta = (struct tlb_args *)arg;
	local_flush_tlb_kernel_range(ta->ta_start, ta->ta_end);
}

void flush_tlb_all(void)
{
	if (tlb_ops_need_broadcast())
		on_each_cpu(ipi_flush_tlb_all, NULL, 1);
	else
		local_flush_tlb_all();
}

void flush_tlb_mm(struct mm_struct *mm)
{
	if (tlb_ops_need_broadcast())
		on_each_cpu_mask(mm_cpumask(mm), ipi_flush_tlb_mm, mm, 1);
	else
		local_flush_tlb_mm(mm);
}

void flush_tlb_page(struct vm_area_struct *vma, unsigned long uaddr)
{
	if (tlb_ops_need_broadcast()) {
		struct tlb_args ta;
		ta.ta_vma = vma;
		ta.ta_start = uaddr;
		on_each_cpu_mask(mm_cpumask(vma->vm_mm), ipi_flush_tlb_page,
					&ta, 1);
	} else
		local_flush_tlb_page(vma, uaddr);
}

void flush_tlb_kernel_page(unsigned long kaddr)
{
	if (tlb_ops_need_broadcast()) {
		struct tlb_args ta;
		ta.ta_start = kaddr;
		on_each_cpu(ipi_flush_tlb_kernel_page, &ta, 1);
	} else
		local_flush_tlb_kernel_page(kaddr);
}

void flush_tlb_range(struct vm_area_struct *vma,
		     unsigned long start, unsigned long end)
{
	if (tlb_ops_need_broadcast()) {
		struct tlb_args ta;
		ta.ta_vma = vma;
		ta.ta_start = start;
		ta.ta_end = end;
		on_each_cpu_mask(mm_cpumask(vma->vm_mm), ipi_flush_tlb_range,
					&ta, 1);
	} else
		local_flush_tlb_range(vma, start, end);
}

void flush_tlb_kernel_range(unsigned long start, unsigned long end)
{
	if (tlb_ops_need_broadcast()) {
		struct tlb_args ta;
		ta.ta_start = start;
		ta.ta_end = end;
		on_each_cpu(ipi_flush_tlb_kernel_range, &ta, 1);
	} else
		local_flush_tlb_kernel_range(start, end);
}
EOF
    fi

    # ============ CORREÇÃO 3: PROC-V7.S - CORREÇÃO DIRETA ============
    _log "CORREÇÃO 3: Corrigindo proc-v7.S diretamente"

    if [ -f arch/arm/mm/proc-v7.S ]; then
        cp arch/arm/mm/proc-v7.S arch/arm/mm/proc-v7.S.backup

        _log "Aplicando correções específicas para MSM8226/Matisse3G..."

        # Adicionar definições ausentes no início do arquivo
        if ! grep -q "PMD_FLAGS_SMP" arch/arm/mm/proc-v7.S; then
            # Encontrar onde adicionar (após includes)
            INCLUDE_LINE=$(grep -n "#include.*pgtable.h" arch/arm/mm/proc-v7.S | tail -1 | cut -d: -f1)
            if [ -n "$INCLUDE_LINE" ]; then
                sed -i "${INCLUDE_LINE}a\\
\\
/* Definições específicas para MSM8226 - Matisse3G */\\
#ifndef PMD_FLAGS_SMP\\
#define PMD_FLAGS_SMP\\t(PMD_SECT_S | PMD_SECT_nG)\\
#endif\\
#ifndef PMD_FLAGS_UP\\
#define PMD_FLAGS_UP\\t(PMD_SECT_nG)\\
#endif" arch/arm/mm/proc-v7.S
            fi
        fi

        # Corrigir a macro __v7_proc problemática
        # Substituir ALT_SMP e ALT_UP por definições estáticas
        sed -i '/ALT_SMP(.long.*PMD_FLAGS_SMP/c\
#ifdef CONFIG_SMP\
\t.long\tPMD_TYPE_SECT | PMD_SECT_AP_WRITE | PMD_SECT_AP_READ | \\\
\t\tPMD_SECT_AF | PMD_SECT_S | PMD_SECT_nG | \\mm_mmuflags\
#else' arch/arm/mm/proc-v7.S

        sed -i '/ALT_UP(.long.*PMD_FLAGS_UP/c\
\t.long\tPMD_TYPE_SECT | PMD_SECT_AP_WRITE | PMD_SECT_AP_READ | \\\
\t\tPMD_SECT_AF | PMD_SECT_nG | \\mm_mmuflags\
#endif' arch/arm/mm/proc-v7.S

        # Corrigir W(b) para b
        sed -i 's/W(b)/b/g' arch/arm/mm/proc-v7.S

        # Remover HWCAP_TLS problemático
        sed -i 's/HWCAP_EDSP | HWCAP_TLS/HWCAP_EDSP/g' arch/arm/mm/proc-v7.S

        # Adicionar entrada específica para MSM8226 se não existir
        if ! grep -q "__msm8226_proc_info" arch/arm/mm/proc-v7.S; then
            # Encontrar onde adicionar (antes da entrada genérica)
            V7_PROC_LINE=$(grep -n "__v7_proc_info:" arch/arm/mm/proc-v7.S | head -1 | cut -d: -f1)
            if [ -n "$V7_PROC_LINE" ]; then
                sed -i "${V7_PROC_LINE}i\\
\\t/*\\
\\t * Qualcomm MSM8226 - Samsung Matisse3G\\
\\t */\\
\\t.type   __msm8226_proc_info, #object\\
__msm8226_proc_info:\\
\\t.long\\t0x410fc070\\t\\t/* Cortex-A7 r0p0 */\\
\\t.long\\t0xff0ffff0\\
\\t__v7_proc __v7_setup, hwcaps = HWCAP_IDIV\\
\\t.size\\t__msm8226_proc_info, . - __msm8226_proc_info\\
\\
" arch/arm/mm/proc-v7.S
            fi
        fi

        _log "proc-v7.S corrigido para MSM8226"
    else
        _log "AVISO: proc-v7.S não encontrado"
    fi

    # ============ OUTRAS CORREÇÕES ============
    _log "Aplicando outras correções necessárias..."

    # Correção entry-armv.S
    if [ -f arch/arm/kernel/entry-armv.S ]; then
        cp arch/arm/kernel/entry-armv.S arch/arm/kernel/entry-armv.S.backup
        sed -i 's/#ifdef CONFIG_ARM_THUMB()/#ifdef CONFIG_ARM_THUMB/g' arch/arm/kernel/entry-armv.S
    fi

    # Correção entry-header.S
    if [ -f arch/arm/kernel/entry-header.S ]; then
        cp arch/arm/kernel/entry-header.S arch/arm/kernel/entry-header.S.backup
        sed -i '185s/#if ((sizeof(struct pt_regs) % 8) != 0)/#if 0 \/\* disabled \*\//' arch/arm/kernel/entry-header.S
    fi

    # Limpar definições conflitantes de false/true
    find arch/arm/mach-msm/ include/linux/mfd/ sound/soc/codecs/ -name "*.h" -type f 2>/dev/null | while read header; do
        if [ -f "$header" ] && grep -q "#define false\|#define true" "$header" 2>/dev/null; then
            cp "$header" "${header}.backup"
            sed -i '/#define false/d' "$header"
            sed -i '/#define true/d' "$header"
        fi
    done

    # uapi/linux/types.h se necessário
    if [ ! -f include/uapi/linux/types.h ]; then
        cat > include/uapi/linux/types.h << 'EOF'
#ifndef _UAPI_LINUX_TYPES_H
#define _UAPI_LINUX_TYPES_H
#include <asm/types.h>
#ifndef __ASSEMBLY__
typedef __u16 __le16;
typedef __u16 __be16;
typedef __u32 __le32;
typedef __u32 __be32;
typedef __u64 __le64;
typedef __u64 __be64;
#endif
#endif
EOF
    fi

    # Headers GCC modernos
    for ver in 14 15; do
        if [ ! -f "include/linux/compiler-gcc${ver}.h" ]; then
            cat > "include/linux/compiler-gcc${ver}.h" <<'EOF'
#ifndef __LINUX_COMPILER_H
#error "Please include <linux/compiler.h> instead"
#endif

#define __used			__attribute__((__used__))
#define __must_check		__attribute__((warn_unused_result))
#define __compiler_offsetof(a,b) __builtin_offsetof(a,b)
#define __always_inline		inline __attribute__((always_inline))
#define __deprecated		__attribute__((deprecated))
#define __packed		__attribute__((packed))
#define __weak			__attribute__((weak))

#pragma GCC diagnostic ignored "-Wendif-labels"
#pragma GCC diagnostic ignored "-Wformat-security"
EOF
        fi
    done

    # ============ CONFIGURAÇÃO ============
    _log "Aplicando configuração..."
    cp "$srcdir/config-samsung-matisse3g.armv7" .config

    # Configurações específicas otimizadas
    cat >> .config <<'EOF'
# MSM8226 Específico
CONFIG_DEBUG_FS=n
CONFIG_OF=y
CONFIG_SPMI=y
CONFIG_OF_SPMI=y
CONFIG_REGULATOR=y
CONFIG_MSM_RPM_SMD=y

# Desabilitar problemáticos
CONFIG_SOUND=n
CONFIG_SND=n
CONFIG_MODVERSIONS=n
CONFIG_WERROR=n

# ARM/ABI Otimizado
CONFIG_AEABI=y
CONFIG_OABI_COMPAT=n
CONFIG_ARM_UNWIND=n
CONFIG_THUMB2_KERNEL=n

# Sparse
CONFIG_SPARSE_RCU_POINTER=n
CONFIG_CONTEXT=n

# Preemption
CONFIG_PREEMPT_NONE=y
CONFIG_PREEMPT_VOLUNTARY=n
CONFIG_PREEMPT=n
CONFIG_PREEMPT_COUNT=n
EOF

    _log "Executando oldconfig..."
    yes "" | make -s ARCH=arm CROSS_COMPILE="${_cross_prefix}" oldconfig || _die "oldconfig falhou"

    _log "Executando prepare..."
    make -s ARCH=arm CROSS_COMPILE="${_cross_prefix}" prepare || _die "prepare falhou"

    _log "Preparação concluída - Matisse3G otimizado!"
}

build() {
    cd "$builddir"
    _log "Compilando kernel Matisse3G..."

    unset LDFLAGS CPPFLAGS CFLAGS CXXFLAGS
    export LDFLAGS=""
    export HOSTCFLAGS="-fno-PIE -no-pie -fno-stack-protector -Wno-error"
    export HOSTLDFLAGS="-no-pie"

    # Compilação com flags otimizadas para MSM8226
    local build_flags="ARCH=arm CROSS_COMPILE=${_cross_prefix} LDFLAGS="

    _log "Compilando zImage..."
    make -j1 $build_flags zImage || _die "Falha na compilação do zImage"

    _log "Compilando módulos..."
    make -j1 $build_flags modules || _log "Alguns módulos falharam (normal para port inicial)"

    _log "Compilação Matisse3G concluída!"
}

package() {
    cd "$builddir"
    _log "Empacotando kernel Matisse3G..."

    make DESTDIR="$pkgdir" \
        INSTALL_MOD_PATH="$pkgdir" \
        ARCH=arm \
        CROSS_COMPILE="${_cross_prefix}" \
        modules_install || true

    install -Dm644 arch/arm/boot/zImage "$pkgdir/boot/vmlinuz-samsung-matisse3g"

    if [ -d arch/arm/boot/dts ] && [ -n "$(find arch/arm/boot/dts -name '*.dtb' 2>/dev/null)" ]; then
        mkdir -p "$pkgdir/boot/dtbs"
        find arch/arm/boot/dts -name '*.dtb' -exec cp {} "$pkgdir/boot/dtbs/" \; 2>/dev/null || true
    fi

    _log "Empacotamento Matisse3G concluído!"
}

sha512sums="
7fa4253037e154e2f245e12b4d7999887d6fcf99c9e7d30601ecf53a2fe5d47f1a423dd9483dac9eec86b7e5a9daf0b48e8ddde7311cd091a66630ff0656bd45  linux-samsung-matisse3g-pmos-matisse3g-fixes.tar.gz
644fa94f06ca1aef030f6f5d707948afacb12b213cae2fe8f78b933fddcf7aa906db468b7f6ba53f5ff88ad91956905ead1e3fe0294fd6c902a9bd0fc7180b93  config-samsung-matisse3g.armv7
"
