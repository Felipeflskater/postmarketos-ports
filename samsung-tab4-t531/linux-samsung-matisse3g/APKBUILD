# Maintainer: Felipe Aranalde <felipe.aranalde@gmail.com>

pkgname=linux-samsung-matisse3g
pkgver=3.4.0
pkgrel=0
pkgdesc="Kernel para o Samsung Galaxy Tab 4 10.1 (SM-T531)"
arch="armv7"
_flavor="samsung-matisse3g"
url="https://github.com/matissewifi/android_kernel_samsung_matisse"
license="GPL-2.0-only"
makedepends="
    bash
    bc
    bison
    devicepkg-dev
    dtbtool
    dtc
    elfutils-dev
    findutils
    flex
    gmp-dev
    installkernel
    linux-headers
    openssl-dev
    perl
    sed
"
options="!strip !check !tracedeps"

source="
    https://github.com/matissewifi/android_kernel_samsung_matisse/archive/refs/heads/cm-14.1.tar.gz
    config-samsung-matisse3g.armv7
"
builddir="$srcdir/android_kernel_samsung_matisse-cm-14.1"

prepare() {
    cd "$builddir"

    echo "[*] Aplicando .config manualmente"
    cp "$srcdir"/config-samsung-matisse3g.armv7 .config

    echo "[*] Forçando aceitação do .config com olddefconfig (não-interativo)"
    yes "" | make ARCH=arm olddefconfig

    echo "[*] Garantindo que CONFIG_ARCH_RANDOM esteja definido"
    grep -q "CONFIG_ARCH_RANDOM" .config || echo "# CONFIG_ARCH_RANDOM is not set" >> .config

    echo "[*] Corrigindo Makefiles com TABs"
    find . -name 'Makefile*' -exec sed -i 's/^\([ ]\{1,\}\)/\t/' {} +

    echo "[*] Corrigindo scripts Python"
    find . -type f -name "*.py" -exec grep -L "^#!" {} \; | while read -r f; do
        sed -i '1i#!/usr/bin/env python3' "$f"
    done

    echo "[*] Corrigindo includes ausentes"
    find . -type f \( -name "*.c" -o -name "*.h" \) -exec \
        sed -i '/^#include <linux\/kernel.h>/a #include <linux/types.h>' {} +

    echo "[*] Substituindo funções antigas"
    find . -type f -exec sed -i 's/strict_strtoul/kstrtoul/g' {} +
    find . -type f -exec sed -i 's/strict_strtol/kstrtol/g' {} +

    echo "[*] Corrigindo zconf.gperf"
    [ -f scripts/kconfig/zconf.gperf ] && sed -i '1i%option noinput' scripts/kconfig/zconf.gperf || true

    echo "[*] Gerando arquivos de configuração para evitar silentoldconfig"
    mkdir -p include/config include/generated
    echo '"3.4.0"' > include/config/kernel.release
    touch include/config/auto.conf
    touch include/generated/autoconf.h
    touch include/generated/utsrelease.h
}

build() {
    cd "$builddir"
    make ARCH=arm CROSS_COMPILE=armv7-alpine-linux-musleabihf- zImage dtbs
}

package() {
    cd "$builddir"
    mkdir -p "$pkgdir"/boot
    cp arch/arm/boot/zImage "$pkgdir"/boot/zImage-$_flavor
    cp arch/arm/boot/dts/*.dtb "$pkgdir"/boot/ 2>/dev/null || true
}

sha512sums="
5f75c3531f91fe879b649f8b8bfd70b5158a85d569a4943d217a5c1308b2c790bbc79fbb9ad02713f9fdb26e45d088511dd66d76c90568c8c70086356abec45f  cm-14.1.tar.gz
ec2f99bfc0a1a23a58991b248212b74cc860dae93339fd8df52bd155f30158d6a17b7ff4a6cac47ce6b6b2aae2503eb87b15c9f447188ab720c84eddeb78184d  config-samsung-matisse3g.armv7
"
