# Maintainer: Felipe Prestes Aranalde <felipe.aranalde@gmail.com>
pkgname=linux-samsung-matisse3g
pkgver=3.4.113
pkgrel=19
pkgdesc="Kernel Linux para Samsung Galaxy Tab 4 10.1 (SM-T531) - Otimizado para PostmarketOS"
arch="armv7"
_flavor="samsung-matisse3g"
url="https://github.com/felipeflskater/android_kernel_samsung_msm8226"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="
	bash bc bison devicepkg-dev dtbtool elfutils-dev findutils flex
	gmp-dev installkernel linux-headers mpc1-dev mpfr-dev
	perl python3 sed xz gcc-arm-none-eabi
"

_commit="pmos-matisse3g-fixes"

source="
	$pkgname-$_commit.tar.gz::https://github.com/Felipeflskater/android_kernel_samsung_msm8226/archive/refs/heads/$_commit.tar.gz
	config-samsung-matisse3g.armv7
	01-fix-timex-header.patch
	03-fix-defconfig.patch
"
builddir="$srcdir/android_kernel_samsung_msm8226-$_commit"

_log() {
    printf "\n[*] %s\n" "$1"
}

_die() {
    _log "ERRO: $1"
    exit 1
}

# Função para aplicar correções via código em vez de patches
_apply_code_fixes() {
    _log "Aplicando correções via código..."

    # CORREÇÃO 1: Timex.h (já aplicada pelo patch 01)
    _log "Verificando correção do timex.h..."

    # CORREÇÃO 2: GCC15 compatibility no compiler.h
    if [ -f include/linux/compiler.h ]; then
        if ! grep -q "GCC 15+ compatibility" include/linux/compiler.h; then
            _log "Adicionando suporte GCC 15+ ao compiler.h..."
            cat >> include/linux/compiler.h << 'EOF'

/* GCC 15+ compatibility - added by pmbootstrap */
#ifndef __always_inline
#define __always_inline inline __attribute__((always_inline))
#endif
#ifndef __deprecated
#define __deprecated __attribute__((deprecated))
#endif
#ifndef __force
#define __force __attribute__((force))
#endif
EOF
        fi
    fi

    # CORREÇÃO 3: Makefile flags para GCC 15+
    if [ -f Makefile ]; then
        if ! grep -q "GCC 15+ compatibility" Makefile; then
            _log "Adicionando flags GCC 15+ ao Makefile..."
            cat >> Makefile << 'EOF'

# GCC 15+ compatibility - added by pmbootstrap
KBUILD_CFLAGS += -fgnu89-inline -std=gnu89 -Wno-error
KBUILD_CFLAGS += -Wno-array-bounds -Wno-stringop-overflow -Wno-format-overflow
HOSTCFLAGS := -fgnu89-inline -std=gnu89 -O2 -fno-PIE -static
HOSTCXXFLAGS := -fgnu89-inline -O2 -fno-PIE -static
HOSTLDFLAGS := -static
EOF
        fi
    fi

    # CORREÇÃO 4: VFP entry.S com offsets hardcoded
    if [ -f arch/arm/vfp/entry.S ]; then
        _log "Corrigindo VFP entry.S..."
        # Substituir referências problemáticas por offsets fixos
        sed -i 's/#TI_PREEMPT/#8/g' arch/arm/vfp/entry.S 2>/dev/null || true
        sed -i 's/#S_PC/#60/g' arch/arm/vfp/entry.S 2>/dev/null || true
        sed -i 's/#TI_CPU/#20/g' arch/arm/vfp/entry.S 2>/dev/null || true
        sed -i 's/#TI_VFPSTATE/#144/g' arch/arm/vfp/entry.S 2>/dev/null || true
    fi

    # CORREÇÃO 5: Memory macros
    if [ -f arch/arm/include/asm/memory.h ]; then
        if ! grep -q "GCC 15+ compatibility" arch/arm/include/asm/memory.h; then
            _log "Corrigindo memory.h..."
            # Adicionar definições UL no início do arquivo
            sed -i '/^#ifndef _ASMARM_MEMORY_H/a\
\
/* GCC 15+ compatibility - UL macro fix */\
#ifndef __ASSEMBLY__\
#ifndef UL\
#define UL(x) _AC(x, UL)\
#endif\
#else\
#define UL(x) (x)\
#endif' arch/arm/include/asm/memory.h

            # Substituir definições problemáticas por valores fixos
            sed -i 's/#define PAGE_OFFSET.*UL(CONFIG_PAGE_OFFSET).*/#define PAGE_OFFSET             UL(0xC0000000)/' arch/arm/include/asm/memory.h
            sed -i 's/#define PHYS_OFFSET.*UL(CONFIG_PHYS_OFFSET).*/#define PHYS_OFFSET             UL(0x00000000)/' arch/arm/include/asm/memory.h
        fi
    fi

    # CORREÇÃO 6: const.h para _AC macro
    if [ -f include/linux/const.h ]; then
        if ! grep -q "__AC" include/linux/const.h; then
            _log "Adicionando macro _AC ao const.h..."
            cat >> include/linux/const.h << 'EOF'

/* _AC macro for memory.h compatibility */
#ifndef __AC
#define __AC(X,Y)	(X##Y)
#define _AC(X,Y)	__AC(X,Y)
#endif
EOF
        fi
    fi

    # CORREÇÃO 7: kbuild.h se não existir
    if [ ! -f include/linux/kbuild.h ]; then
        _log "Criando include/linux/kbuild.h..."
        mkdir -p include/linux
        cat > include/linux/kbuild.h << 'EOF'
#ifndef __LINUX_KBUILD_H
#define __LINUX_KBUILD_H

#define DEFINE(sym, val) \
        __asm__ __volatile__("\n->" #sym " %0 " #val : : "i" (val))

#define BLANK() \
        __asm__ __volatile__("\n->" : : )

#define OFFSET(sym, str, mem) \
        DEFINE(sym, offsetof(struct str, mem))

#define COMMENT(x) \
        __asm__ __volatile__("\n->#" x)

#endif
EOF
    fi

    # CORREÇÃO 8: asm-offsets.c user attribute
    if [ -f arch/arm/kernel/asm-offsets.c ]; then
        if ! grep -q "__user.*address_space" arch/arm/kernel/asm-offsets.c; then
            _log "Corrigindo asm-offsets.c..."
            sed -i '/#include <linux\/sched.h>/a\
\
/* GCC 15+ compatibility */\
#ifndef __user\
#define __user __attribute__((noderef, address_space(1)))\
#endif' arch/arm/kernel/asm-offsets.c
        fi
    fi

    # CORREÇÃO 9: Criar mach/msm_rtb.h faltante
    if [ ! -f arch/arm/mach-msm/include/mach/msm_rtb.h ]; then
        _log "Criando mach/msm_rtb.h faltante..."
        mkdir -p arch/arm/mach-msm/include/mach
        cat > arch/arm/mach-msm/include/mach/msm_rtb.h << 'EOF'
/*
 * MSM RTB (Real Time Buffer) - Stub implementation for PostmarketOS
 * Original header missing - providing minimal implementation
 */

#ifndef __MACH_MSM_RTB_H
#define __MACH_MSM_RTB_H

/* Empty stub - RTB functionality disabled for PostmarketOS build */
static inline void msm_rtb_disable(void) { }

#endif /* __MACH_MSM_RTB_H */
EOF
    fi

    # CORREÇÃO 10: Corrigir arch/arm/include/asm/io.h para lidar com header faltante
    if [ -f arch/arm/include/asm/io.h ]; then
        if grep -q "#include <mach/msm_rtb.h>" arch/arm/include/asm/io.h; then
            _log "Corrigindo include problemático em asm/io.h..."
            sed -i 's/#include <mach\/msm_rtb.h>/#ifdef CONFIG_MSM_RTB\n#include <mach\/msm_rtb.h>\n#endif/' arch/arm/include/asm/io.h
        fi
    fi

    # CORREÇÃO 11: Corrigir redefinições de true/false
    if [ -f include/linux/stddef.h ]; then
        if ! grep -q "ifndef.*false" include/linux/stddef.h; then
            _log "Corrigindo redefinições de true/false..."
            sed -i 's/#define false __kernel_false/#ifndef false\n#define false __kernel_false\n#endif/' include/linux/stddef.h
            sed -i 's/#define true  __kernel_true/#ifndef true\n#define true  __kernel_true\n#endif/' include/linux/stddef.h
        fi
    fi

    # CORREÇÃO 12: Corrigir warnings de formato em JFFS2
    if [ -f fs/jffs2/wbuf.c ]; then
        if ! grep -q "pragma GCC diagnostic" fs/jffs2/wbuf.c; then
            _log "Corrigindo warnings de formato em JFFS2..."
            # Adicionar pragmas para ignorar warnings de formato no início do arquivo
            sed -i '1i\
/* GCC 15+ format warning suppression for PostmarketOS */\
#pragma GCC diagnostic push\
#pragma GCC diagnostic ignored "-Wformat"\
#pragma GCC diagnostic ignored "-Wformat-overflow"\
#pragma GCC diagnostic ignored "-Wformat-truncation"' fs/jffs2/wbuf.c

            # Adicionar pragma de restore no final
            echo -e '\n#pragma GCC diagnostic pop' >> fs/jffs2/wbuf.c
        fi
    fi

    # CORREÇÃO 13: Adicionar flags globais mais agressivos para suprimir warnings
    if [ -f Makefile ]; then
        if ! grep -q "Wno-format-overflow" Makefile; then
            _log "Adicionando flags agressivos para warnings de formato..."
            cat >> Makefile << 'EOF'

# Additional GCC 15+ format warning suppression
KBUILD_CFLAGS += -Wno-format -Wno-format-overflow -Wno-format-truncation
KBUILD_CFLAGS += -Wno-format-security -Wno-format-nonliteral -Wno-format-y2k
KBUILD_CFLAGS += -Wno-format-extra-args -Wno-format-zero-length
EOF
        fi
    fi

    _log "Correções aplicadas via código"
}

_detect_cross_compiler() {
    local compilers="arm-none-eabi-gcc armv7-alpine-linux-musleabihf-gcc arm-linux-gnueabihf-gcc"

    for compiler in $compilers; do
        if command -v "$compiler" >/dev/null 2>&1; then
            export CROSS_COMPILE="${compiler%-gcc}-"
            _log "Usando $compiler"
            return 0
        fi
    done

    _die "Nenhum compilador cruzado ARM encontrado!"
}

_setup_gcc15_environment() {
    _log "Configurando ambiente para GCC 15+..."

    # Limpar flags conflitantes
    unset LDFLAGS CPPFLAGS CFLAGS CXXFLAGS

    export ARCH=arm
    export SUBARCH=arm

    # Host flags
    export HOSTCC="gcc"
    export HOSTCXX="g++"
    export HOSTCFLAGS="-fgnu89-inline -std=gnu89 -O2 -static -fno-PIE"
    export HOSTCXXFLAGS="-fgnu89-inline -O2 -static -fno-PIE"
    export HOSTLDFLAGS="-static"

    # Kernel flags
    local base_flags="-std=gnu89 -fno-stack-protector -fno-strict-aliasing -fno-common"
    local warning_flags="-Wno-error -Wno-array-bounds -Wno-stringop-overflow -Wno-format-overflow"
    warning_flags="$warning_flags -Wno-stringop-truncation -Wno-dangling-pointer -Wno-address"
    local compat_flags="-fgnu89-inline -fno-strict-overflow -fconserve-stack -fno-builtin"
    local gcc15_flags="-fno-PIE -fno-pic -no-pie -Wno-error=incompatible-pointer-types"
    gcc15_flags="$gcc15_flags -Wno-error=discarded-qualifiers -Wno-error=implicit-function-declaration"

    export KCFLAGS="$base_flags $warning_flags $compat_flags $gcc15_flags"
    export AFLAGS="-Wa,--fatal-warnings -Wa,--noexecstack -Wa,-mno-warn-deprecated"
    export KBUILD_AFLAGS="$AFLAGS"
    export KBUILD_CFLAGS="$KCFLAGS"

    # Forçar versões fixas
    export KERNELRELEASE="3.4.113"
    export UTS_RELEASE="3.4.113"

    _log "Ambiente configurado"
}

prepare() {
    cd "$builddir"
    _log "Preparando kernel Matisse3G..."

    # 1. Configurar ambiente
    _detect_cross_compiler
    _setup_gcc15_environment

    # 2. Aplicar patches disponíveis (apenas os que funcionam)
    _log "Aplicando patches disponíveis..."
    for patch in $source; do
        case $patch in
            *.patch)
                if [ -f "$srcdir/$patch" ]; then
                    _log "Aplicando $patch..."
                    patch -p1 -i "$srcdir/$patch" || _log "AVISO: $patch falhou"
                fi
                ;;
        esac
    done

    # 3. Aplicar correções que falharam via código
    _apply_code_fixes

    # 4. Configuração
    if [ -f "$srcdir/config-samsung-matisse3g.armv7" ]; then
        cp "$srcdir/config-samsung-matisse3g.armv7" .config
    fi

    # 5. Criar arquivos necessários
    mkdir -p include/generated include/config scripts/basic scripts/kconfig
    echo '#define UTS_RELEASE "3.4.113"' > include/generated/utsrelease.h
    echo '/* Auto generated */' > include/generated/autoconf.h
    touch include/generated/bounds.h
    touch include/generated/asm-offsets.h

    # 6. Preparar build
    make ARCH=arm CROSS_COMPILE="$CROSS_COMPILE" \
         HOSTCC="$HOSTCC" HOSTCFLAGS="$HOSTCFLAGS" HOSTLDFLAGS="$HOSTLDFLAGS" \
         scripts_basic 2>/dev/null || _log "AVISO: scripts_basic falhou"

    make ARCH=arm CROSS_COMPILE="$CROSS_COMPILE" \
         HOSTCC="$HOSTCC" HOSTCFLAGS="$HOSTCFLAGS" HOSTLDFLAGS="$HOSTLDFLAGS" \
         defconfig 2>/dev/null || _log "Usando configuração existente"

    _log "Preparação concluída"
}

build() {
    cd "$builddir"
    _log "Compilando kernel..."

    # Proteger utsrelease.h
    if [ -f include/generated/utsrelease.h ]; then
        chmod 444 include/generated/utsrelease.h
    fi

    # Compilar
    make ARCH=arm CROSS_COMPILE="$CROSS_COMPILE" \
         HOSTCC="$HOSTCC" HOSTCFLAGS="$HOSTCFLAGS" HOSTLDFLAGS="$HOSTLDFLAGS" \
         KCFLAGS="$KCFLAGS" AFLAGS="$AFLAGS" \
         KERNELRELEASE="$KERNELRELEASE" UTS_RELEASE="$UTS_RELEASE" \
         -j$(nproc) zImage || _die "Falha na compilação do zImage"

    make ARCH=arm CROSS_COMPILE="$CROSS_COMPILE" \
         HOSTCC="$HOSTCC" HOSTCFLAGS="$HOSTCFLAGS" HOSTLDFLAGS="$HOSTLDFLAGS" \
         KCFLAGS="$KCFLAGS" AFLAGS="$AFLAGS" \
         KERNELRELEASE="$KERNELRELEASE" UTS_RELEASE="$UTS_RELEASE" \
         -j$(nproc) modules || _log "AVISO: Alguns módulos falharam"

    _log "Compilação concluída"
}

package() {
    cd "$builddir"
    _log "Empacotando kernel..."

    install -Dm644 arch/arm/boot/zImage "$pkgdir/boot/vmlinuz-$_flavor"

    make DESTDIR="$pkgdir" INSTALL_MOD_PATH="$pkgdir" \
         ARCH=arm CROSS_COMPILE="$CROSS_COMPILE" \
         modules_install 2>/dev/null || _log "AVISO: Módulos falharam"

    if [ -d arch/arm/boot/dts ]; then
        dtb_count=$(find arch/arm/boot/dts -name "*.dtb" 2>/dev/null | wc -l)
        if [ "$dtb_count" -gt 0 ]; then
            mkdir -p "$pkgdir/boot/dtbs-$_flavor"
            find arch/arm/boot/dts -name "*.dtb" -exec cp {} "$pkgdir/boot/dtbs-$_flavor/" \; 2>/dev/null
        fi
    fi

    mkdir -p "$pkgdir/boot"
    ln -sf "vmlinuz-$_flavor" "$pkgdir/boot/vmlinuz" || true

    _log "Empacotamento concluído"
}

sha512sums="
7fa4253037e154e2f245e12b4d7999887d6fcf99c9e7d30601ecf53a2fe5d47f1a423dd9483dac9eec86b7e5a9daf0b48e8ddde7311cd091a66630ff0656bd45  linux-samsung-matisse3g-pmos-matisse3g-fixes.tar.gz
9bcc57e7a3de597dec583da93f5cab0200f48dc053eaeaeb499dab993f50c5a5af5639b14c3eaa04f72eb430df694a920613116e2b9008fab4da86ca92311606  config-samsung-matisse3g.armv7
f3bbc54d1c3433310f701c0da130c165d8baab29d924ad90a7021c40818e767066c10b6c2467b97d92b43191a7d0e1bb389dc056463263c14347e9e4582ae0ca  01-fix-timex-header.patch
726321e16d16edad715abd4bc83e9f546902e11b5d2c5f5ab1b7076872ad0fceee85d2e512e8007a78c0a956b3454b239b9a844149a87094a342d91030972889  03-fix-defconfig.patch
"
